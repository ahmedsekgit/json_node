"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(r="Object"===r&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function _createSuper(r){var i=_isNativeReflectConstruct();return function(){var e,t=_getPrototypeOf(r);return _possibleConstructorReturn(this,i?(e=_getPrototypeOf(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function _possibleConstructorReturn(e,t){return!t||"object"!==_typeof(t)&&"function"!=typeof t?_assertThisInitialized(e):t}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _typeof(e){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}!function(e){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this).FlyJsonQL=e()}(function(){var define,module,exports;return function i(n,o,s){function a(t,e){if(!o[t]){if(!n[t]){var r="function"==typeof require&&require;if(!e&&r)return r(t,!0);if(u)return u(t,!0);throw(r=new Error("Cannot find module '"+t+"'")).code="MODULE_NOT_FOUND",r}r=o[t]={exports:{}},n[t][0].call(r.exports,function(e){return a(n[t][1][e]||e)},r,r.exports,i,n,o,s)}return o[t].exports}for(var u="function"==typeof require&&require,e=0;e<s.length;e++)a(s[e]);return a}({1:[function(e,t,r){var i=e("./helper"),h=e("./operator"),e=function(){_inherits(r,i);var t=_createSuper(r);function r(){var e;return _classCallCheck(this,r),(e=t.call(this)).data1=[],e.data2=[],e.query=[],e.result=[],e}return _createClass(r,[{key:"_sortBy",value:function(t,r,i){var n=i?function(e){return i(e[t])}:function(e){return e[t]};return r=r?-1:1,function(e,t){return e=n(e),t=n(t),r*((t<e)-(e<t))}}},{key:"_findDistinct",value:function(n,t){for(var o=this,s=!1,e=0;e<n.length;e++)!function(r){var e=Object.keys(t).length,i=0;o.foreach(t,function(e,t){n[r][t]===e&&i++}),e===i&&(s=!0)}(e);return s}},{key:"setMode",value:function(e){return this.mode=e.toString().toLowerCase(),this}},{key:"set",value:function(e){if(!this.isArray(e))throw new Error("Set data must be an array contains object.");return"shallow"===this.mode?this.data1=this.shallowClone(e):this.data1=this.deepClone(e),this}},{key:"insert",value:function(e){if(!this.isObject(e)||this.isEmptyObject(e))throw new Error("New value must be an object and not empty");return this.data1.push(e),this}},{key:"insertMany",value:function(e){if(!this.isArray(e))throw new Error("Data must be an array object");for(var t=e.length,r=0;r<t;r++){if(!this.isObject(e[r])||this.isEmptyObject(e[r]))throw new Error("New value must be an object and not empty");this.data1.push(e[r])}return this}},{key:"update",value:function(e,t,r){if(this.isEmpty(e)||this.isEmpty(t))throw new Error("Key and Value must be defined and value must be unique");if(!this.isObject(r)||this.isEmptyObject(r))throw new Error("New value must be an object and not empty");for(var i=this.data1.length,n=0;n<i;n++)if(this.data1[n][e]===t){this.data1.splice(n,1),this.data1.push(Object.assign(_defineProperty({},e,t),r));break}return this}},{key:"updateMany",value:function(e,t){if(this.isEmpty(e)||!this.isString(e))throw new Error("Key and Value must be defined and value must be unique");if(this.isEmptyArray(t)||!this.isArray(t))throw new Error("Data to update must be an array object and not empty");for(var r,i=this.data1.length,n=t.length,o=[],s=0;s<i;s++){r=!1;for(var a=0;a<n;a++)this.data1[s][e]===t[a][e]&&(r=!0,o.push(t[a]));!1===r&&o.push(this.data1[s])}return this.data1=o,this}},{key:"modify",value:function(e,t,r){if(this.isEmpty(e)||this.isEmpty(t))throw new Error("Key and Value must be defined and value must be unique");if(!this.isObject(r)||this.isEmptyObject(r))throw new Error("New value must be an object and not empty");for(var i,n=this.data1.length,o=0;o<n;o++)if(this.data1[o][e]===t){i=this.data1[o],this.data1.splice(o,1),this.data1.push(Object.assign(_defineProperty({},e,t),i,r));break}return this}},{key:"modifyMany",value:function(e,t){if(this.isEmpty(e)||!this.isString(e))throw new Error("Key must be defined");if(this.isEmptyArray(t)||!this.isArray(t))throw new Error("Data to modify must be an array object and not empty");if("shallow"===this.mode)throw new Error("Shallow mode is not allowed for modifyMany!");for(var r,i,n=this.data1.length,o=t.length,s=[],a=0;a<n;a++){i=!1;for(var u=0;u<o;u++)this.data1[a][e]===t[u][e]&&(i=!0,r=this.data1[a],s.push(Object.assign(r,t[u])));!1===i&&s.push(this.data1[a])}return this.data1=s,this}},{key:"delete",value:function(e,t){if(this.isEmpty(e)||this.isEmpty(t))throw new Error("Key and Value must be defined also remember that Value must be unique.");for(var r=this.data1.length,i=0;i<r;i++)if(this.data1[i][e]===t){this.data1.splice(i,1);break}return this}},{key:"deleteMany",value:function(e,t){if(this.isEmpty(e)||this.isEmptyArray(t))throw new Error("Key and Data array of key value must be defined.");for(var r=this.data1.length,i=t.length,n=[],o=!1,s=0;s<r;s++){o=!1;for(var a=0;a<i;a++)this.data1[s][e]===t[a]&&(o=!0);!1===o&&n.push(this.data1[s])}return this.data1=n,this}},{key:"select",value:function(e){if(!this.isEmpty(e)&&this.isArray(e)&&!this.isEmptyArray(e)){for(var t,r=[],i=this.data1.length,n=e.length,o=0;o<i;o++){t={};for(var s=0;s<n;s++)void 0!==this.data1[o][e[s]]&&(t[e[s]]=this.data1[o][e[s]]);r.push(t)}this.data1=r}return this}},{key:"where",value:function(){var e,r,i,n,o,s,a,t,u=[];return!this.isEmpty(arguments.length<=0?void 0:arguments[0])&&this.isString(arguments.length<=0?void 0:arguments[0])&&void 0!==(arguments.length<=1?void 0:arguments[1])&&(r=!0,2<arguments.length?(i=arguments.length<=1?void 0:arguments[1],e=arguments.length<=0?void 0:arguments[0],t=arguments.length<=2?void 0:arguments[2],this.isEmpty(arguments.length<=3?void 0:arguments[3])||(r=arguments.length<=3?void 0:arguments[3])):(i="===",e=arguments.length<=0?void 0:arguments[0],t=arguments.length<=1?void 0:arguments[1],r=!0),i=i.toString().toLowerCase(),n=_defineProperty({},e,t),t=(a=this).data1.filter(function(t){return Object.keys(n).every(function(e){switch(o=t[e],s=n[e],!1===r&&"regex"!==i&&(a.isObject(t[e])||(o=t[e]&&t[e].toString().toLowerCase()),s=n[e].toString().toLowerCase()),i){case"=":return h.unstrict(i,o,s);case"!==":return o!==s;case"==":case"!=":return h.unstrict(i,o,s);case">":return s<o;case">=":return s<=o;case"<":return o<s;case"<=":return o<=s;case"in":return a.isString(o)?-1!==o.indexOf(s):(u=[],o&&a.foreach(o,function(e){r?e===s&&u.push(e):(e=a.isString(e)?e.toLowerCase():e)===s&&u.push(e)}),0<u.length);case"not in":return a.isString(o)?-1===o.indexOf(s):(u=[],o&&o.length?(a.foreach(o,function(e){e!==s&&u.push(e)}),u.length===o.length):!!a.isObject(o)&&(a.foreach(o,function(e){r?e!==s&&u.push(e):(e=a.isString(e)?e.toLowerCase():e)!==s&&u.push(e)}),u.length===Object.keys(o).length));case"not":return o!==s;case"like":return-1!==o.indexOf(s);case"not like":return-1===o.indexOf(s);case"regex":return s.test(o);case"function":return s(o);default:return o===s}})}),"query"===this.scope?this.result=t:this.data1=t),this}},{key:"begin",value:function(){return this.scope="query",this}},{key:"or",value:function(){if("query"===this.scope)for(var e=this.result.length,t=0;t<e;t++)this.query.push(this.result[t]);return this}},{key:"end",value:function(){if("query"===this.scope){for(var e=this.result.length,t=0;t<e;t++)this.query.push(this.result[t]);this.data1=this.query,this.query=[],this.result=[],this.scope=""}return this}},{key:"distinct",value:function(e){if(e=void 0===e?"":e,!this.isEmpty(e)&&!this.isString(e)||this.isArray(e)||this.isObject(e))throw new Error("Field name must be string.");var t=this.data1,r=[],i=[],n=t.length;if(!this.isEmpty(e)&&this.isString(e))for(var o=0;o<n;o++)void 0===t[o][e]||r[t[o][e]]||(i.push(t[o]),r[t[o][e]]=1);else for(var s=0;s<n;s++)!1===this._findDistinct(r,t[s])&&(i.push(t[s]),r.push(t[s]));return this.data1=i,this}},{key:"clean",value:function(){return this.data1=[],this.data2=[],this.query=[],this.result=[],this.metadata={},this.scope="",this.mode="",this.name="",this}},{key:"join",value:function(e,t){if(this.isEmpty(e)||!this.isString(e))throw new Error("Name is required and it must be string.");if(!this.isArray(t))throw new Error("Data must be an array object.");return"shallow"===this.mode?this.data2=this.shallowClone(t):this.data2=this.deepClone(t),this.name=e,this.scope="join",this}},{key:"merge",value:function(t,r){if("join"!==this.scope)throw new Error("You should join first before doing merge.");if(this.isEmpty(t)||!this.isString(t))throw new Error("Unique indentifier key for table 1 is required.");if(this.isEmpty(r)||!this.isString(r))throw new Error("Unique indentifier key for table 2 is required.");var i=this.data2.reduce(function(e,t){return e[t[r]]=t,e},{});return this.scope="",this.data1=this.data1.map(function(e){return Object.assign(e,i[e[t]])}),this}},{key:"on",value:function(s,r){var a=this;if("join"!==a.scope)throw new Error("You should join first before doing join on.");if(this.isEmpty(s)||!this.isString(s))throw new Error("Unique indentifier key for table 1 is required.");if(this.isEmpty(r)||!this.isString(r))throw new Error("Unique indentifier key for table 2 is required.");var u=a.data2.reduce(function(e,t){return e[t[r]]=t,e},{}),h=[];return a.data1.map(function(e,t){for(var r={},i=Object.keys(a.data1[t]),n=i.length,o=0;o<n;o++)i[o]===s?a.name===i[o]?r[i[o]]=u[a.data1[t][i[o]]]:(r[a.name]=u[a.data1[t][i[o]]],r[i[o]]=e[i[o]]):r[i[o]]=e[i[o]];return h.push(r)}),a.scope="",a.data1=h,this}},{key:"orderBy",value:function(e,t,r){return t=void 0!==t&&t,!this.isEmpty(e)&&this.isString(e)&&this.isBoolean(t)&&this.data1.sort(this._sortBy(e,t,r)),this}},{key:"groupDetail",value:function(i){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";if(this.isEmpty(i)||!this.isString(i))throw new Error("name is required and must be string.");if(!this.isString(e))throw new Error("group name must be string.");var t=this.data1.reduce(function(e,t){var r=t[i];return e[r]=(e[r]||[]).concat(t),e},{}),r=[];return e?r.push(_defineProperty({},e,t)):r.push(_defineProperty({},i,t)),this.data1=r,this}},{key:"groupBy",value:function(n){var o=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];if(this.isEmpty(n)||!this.isString(n))throw new Error("name is required and must be string.");if(!this.isArray(o))throw new Error("field name for sum must be array.");var s=o.length,e=this.data1.reduce(function(e,t){if(t.item_count=1,t[n]in e){for(var r=0;r<s;r++)e[t[n]][o[r]]+=t[o[r]];e[t[n]].item_count+=1}else e.__array.push(e[t[n]]=t);for(var i=0;i<s;i++)e[t[n]]["average_"+o[i]]=e[t[n]][o[i]]/e[t[n]].item_count;return e},{__array:[]});return this.data1=e.__array,this}},{key:"skip",value:function(e){return!this.isEmpty(e)&&this.isInteger(e)&&(this.data1=this.data1.slice(e)),this}},{key:"take",value:function(e){return this.isEmpty(e)||(e=parseInt(e),this.isInteger(e)&&(this.data1.length=e)),this}},{key:"paginate",value:function(e,t){var r;return this.isEmpty(e)||this.isEmpty(t)||(e=parseInt(e),t=parseInt(t),this.isInteger(e)&&this.isInteger(t)&&(r=this.data1.length,--e,this.data1=this.data1.slice(e*t,(e+1)*t),this.metadata={page:e+1,page_size:t,total_page:Math.ceil(r/t),total_records:r})),this}},{key:"promisify",value:function(r){var i=this;return new Promise(function(e,t){try{e(r.call(i,i))}catch(e){t(e)}})}},{key:"exec",value:function(){return this.mode="",this.data1}}]),r}();t.exports=e},{"./helper":2,"./operator":3}],2:[function(require,module,exports){var Helper=function(){function Helper(){_classCallCheck(this,Helper)}return _createClass(Helper,[{key:"isString",value:function(e){return"string"==typeof e||e instanceof String}},{key:"isInteger",value:function(e){return Number.isInteger(e)}},{key:"isBoolean",value:function(e){return"boolean"==typeof e||"object"===_typeof(e)&&null!==e&&"boolean"==typeof e.valueOf()}},{key:"isArray",value:function(e){return void 0!==e&&""!==e&&(e&&""!==e&&"object"===_typeof(e)&&e.constructor===Array)}},{key:"isObject",value:function(e){return void 0!==e&&""!==e&&(e&&"object"===_typeof(e)&&e.constructor===Object)}},{key:"isEmpty",value:function(e){return null==e||""===e}},{key:"isEmptyArray",value:function(e){return null==e||0===e.length}},{key:"isEmptyObject",value:function(e){return null==e||0===Object.keys(e).length&&e.constructor===Object}},{key:"foreach",value:function(t,e){if(this.isObject(t))for(var r=Object.keys(t),i=Object.keys(t).map(function(e){return t[e]}),n=0,o=r.length;n<o;n++)e(i[n],r[n]);else{if(!Array.isArray(t))throw new Error("Failed to iteration. Data is not an array or object.");for(var s=0,a=t.length;s<a;s++)e(t[s],s)}}},{key:"blockingTest",value:function(){for(var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:1e3,t=Date.now(),r=t+e;Date.now()<r;);return t}},{key:"safeStringify",value:function(e,t){var r=[],t=JSON.stringify(e,function(e,t){if(!(e&&0<e.length)||"$"!==e.charAt(0)&&"_"!==e.charAt(0)){if("object"===_typeof(t)&&null!==t){if(-1!==r.indexOf(t))return;r.push(t)}return t}},t),r=null;return t}},{key:"shallowClone",value:function(e){return _toConsumableArray(e)}},{key:"deepClone",value:function(e){var t;if("object"!==_typeof(e)||!e)return e;if("[object Array]"===Object.prototype.toString.apply(e)){t=[];for(var r=e.length,i=0;i<r;i++)t[i]=this.deepClone(e[i]);return t}for(i in t={},e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=this.deepClone(e[i]));return t}},{key:"jsonTransform",value:function jsonTransform(data,map){var helper=new Helper;return{defaultOrNull:function(e){return e&&map.defaults?map.defaults[e]:null},getValue:function(e,t,r){if(void 0!==e){if(null==t||""===t)return e;for(var i=e,n=null,o=0,s=(n=t.split(".")).length;o<s;o++){if(!(void 0!==i&&n[o]in i))return this.defaultOrNull(r);i=i[n[o]]}return i}},setValue:function(e,t,r){if(void 0!==e&&""!==t&&void 0!==t&&null!=t)for(var i=t.split("."),n=e,o=0,s=i.length;o<s;o++){if(o===i.length-1)return void(n[i[o]]=r);if(!(i[o]in n))return;n=n[i[o]]}},getList:function(){return this.getValue(data,map.list)},make:function(e){var t=this.getValue(data,map.list),r=[];return helper.isEmptyObject(t)||(t=this.getList(),r=map.item?t.map(this.iterator.bind(this,map.item)):t,r=this.operate.bind(this,r)(e),r=this.each(r,e),r=this.removeAll(r)),r},removeAll:function(e){return Array.isArray(map.remove)&&helper.foreach(e,this.remove),e},remove:function(e){for(var t=0,r=map.remove.length;t<r;t++)delete e[map.remove[t]];return e},operate:function operate(data,context){return map.operate&&helper.foreach(map.operate,function(method){data=data.map(function(item){var fn,fn="string"==typeof method.run?eval(method.run):method.run;return this.setValue(item,method.on,fn(this.getValue(item,method.on),context)),item}.bind(this))}.bind(this)),data},each:function(e,i){return map.each&&e.forEach(function(e,t,r){return map.each(e,t,r,i)}),e},iterator:function(e,i){var n={};return"string"==typeof e?this.getValue(i,e):(helper.foreach(e,function(e,t){var r;"string"==typeof e&&0<e.length?n[t]=this.getValue(i,e,t):Array.isArray(e)?(r=e.map(function(e,t){return this.iterator(t,e)}.bind(this,i)),n[t]=r):"object"===_typeof(e)?(e=this.iterator.bind(this,e,i),n[t]=e()):n[t]=""}.bind(this)),n)}}}}]),Helper}();module.exports=Helper},{}],3:[function(e,t,r){t.exports={unstrict:function(e,t,r){switch(e){case"=":case"==":return t==r;case"!=":return t!=r;default:throw new Error("Comparisons operator is not available!")}}}},{}],4:[function(e,t,r){var i=e("fly-json-odm"),e=function(){function e(){_classCallCheck(this,e),this.promiseStack=[],this.content=[],this._odm=new i,this.joined=[]}return _createClass(e,[{key:"odm",get:function(){return this._odm}},{key:"clean",value:function(){this.content=[],this.promiseStack=[]}},{key:"_funcBetween",value:function(e,t,r,i){e.where(t,">=",r).where(t,"<=",i)}},{key:"_funcSearch",value:function(e,t,r){e.where(t,"like",r,!1)}},{key:"_funcRegExp",value:function(e,t,r){e.where(t,"regex",r)}},{key:"_builderWhere",value:function(e,t){if(!this._odm.isEmpty(t)&&this._odm.isArray(t)&&!this._odm.isEmptyArray(t))for(var r=0;r<t.length;r++)e.where.apply(e,_toConsumableArray(t[r]))}},{key:"_builderBetween",value:function(e,t){if(!this._odm.isEmpty(t)&&this._odm.isArray(t)&&!this._odm.isEmptyArray(t))for(var r=0;r<t.length;r++)this._funcBetween.apply(this,[e].concat(_toConsumableArray(t[r])))}},{key:"_builderSearch",value:function(e,t){if(!this._odm.isEmpty(t)&&this._odm.isArray(t)&&!this._odm.isEmptyArray(t))for(var r=0;r<t.length;r++)this._funcSearch.apply(this,[e].concat(_toConsumableArray(t[r])))}},{key:"_builderRegExp",value:function(e,t){if(!this._odm.isEmpty(t)&&this._odm.isArray(t)&&!this._odm.isEmptyArray(t))for(var r=0;r<t.length;r++)this._funcRegExp.apply(this,[e].concat(_toConsumableArray(t[r])))}},{key:"_builderOr",value:function(e,t){if(!this._odm.isEmpty(t)&&this._odm.isArray(t)&&!this._odm.isEmptyArray(t)){e.begin();for(var r=0;r<t.length;r++)this._builderBetween(e,t[r].between),this._builderWhere(e,t[r].where),this._builderSearch(e,t[r].search),this._builderRegExp(e,t[r].regexp),r!==t.length-1&&e.or();e.end()}}},{key:"_builderItemList",value:function(e){for(var t=Object.keys(e[0]),r={},i=0;i<t.length;i++)Object.assign(r,_defineProperty({},t[i],t[i].toString()));return r}},{key:"_builderNested",value:function(e,i){var t=_toConsumableArray(i);t.shift();var r={posts:e},t={list:"posts",item:this._builderItemList(e),each:function(e){for(var t=null,r=1;r<i.length;r++)t=t?(t[i[r]]=e[i[r]],t[i[r]]):(e[i[0]][i[r]]=e[i[r]],e[i[0]][i[r]]);return e},defaults:{missingData:!0},remove:t};return this._odm.jsonTransform(r,t).make()}},{key:"_setFields",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isArray(t)||this._odm.isEmptyArray(t)||e.select(t)}},{key:"_setGroupBy",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isArray(t)||this._odm.isEmptyArray(t)||e.groupBy.apply(e,_toConsumableArray(t))}},{key:"_setGroupDetail",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isArray(t)||this._odm.isEmptyArray(t)||e.groupDetail.apply(e,_toConsumableArray(t))}},{key:"_setOrderBy",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isArray(t)||this._odm.isEmptyArray(t)||e.orderBy.apply(e,_toConsumableArray(t))}},{key:"_setSkip",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isString(t)&&!this._odm.isInteger(t)||e.skip(t)}},{key:"_setTake",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isString(t)&&!this._odm.isInteger(t)||e.take(t)}},{key:"_setDistinct",value:function(e,t){(this._odm.isEmpty(t)||this._odm.isString(t))&&e.distinct(t)}},{key:"_setPaginate",value:function(e,t){this._odm.isEmpty(t)||!this._odm.isArray(t)||this._odm.isEmptyArray(t)||e.paginate.apply(e,_toConsumableArray(t))}},{key:"_mergeScope",value:function(e,t,r){if(!this._odm.isEmpty(r)&&this._odm.isArray(r)&&!this._odm.isEmptyArray(r))for(var i,n,o=r.length,s=[],a=0;a<o;a++)if(r[a].merge){if(0===this.joined.length)this.joined.push((i=t.join(r[a].name,r[a].from)).merge.apply(i,_toConsumableArray(r[a].on)).exec());else for(var u,h=0;h<this.joined.length;h++)s.push((u=t.set(this.joined[h]).join(r[a].name,r[a].from)).merge.apply(u,_toConsumableArray(r[a].on)).exec());this.joined=_toConsumableArray(this.joined.concat(s)),this._mergeScope("nested",t,r[a].merge)}else 0<this.joined.length?((n=t.set(this.joined[this.joined.length-1]).join(r[a].name,r[a].from)).merge.apply(n,_toConsumableArray(r[a].on)),this.joined=[]):(n=t.join(r[a].name,r[a].from)).merge.apply(n,_toConsumableArray(r[a].on)),this._selectScope(e,t,r[a])}},{key:"_joinScope",value:function(e,t,r){if(!this._odm.isEmpty(r)&&this._odm.isArray(r)&&!this._odm.isEmptyArray(r))for(var i,n,o=r.length,s=[],a=0;a<o;a++)if(r[a].join){if(0===this.joined.length)this.joined.push((i=t.join(r[a].name,r[a].from)).on.apply(i,_toConsumableArray(r[a].on)).exec());else for(var u,h=0;h<this.joined.length;h++)s.push((u=t.set(this.joined[h]).join(r[a].name,r[a].from)).on.apply(u,_toConsumableArray(r[a].on)).exec());this.joined=_toConsumableArray(this.joined.concat(s)),this._joinScope("nested",t,r[a].join)}else 0<this.joined.length?((n=t.set(this.joined[this.joined.length-1]).join(r[a].name,r[a].from)).on.apply(n,_toConsumableArray(r[a].on)),this.joined=[]):(n=t.join(r[a].name,r[a].from)).on.apply(n,_toConsumableArray(r[a].on)),this._selectScope(e,t,r[a])}},{key:"_selectScope",value:function(e,t,r){e=e.toLowerCase(),this._builderBetween(t,r.between),this._builderWhere(t,r.where),this._builderSearch(t,r.search),this._builderRegExp(t,r.regexp),this._builderOr(t,r.or),this._setGroupDetail(t,r.groupdetail),this._setGroupBy(t,r.groupby),this._setOrderBy(t,r.orderby),this._setSkip(t,r.skip),this._setTake(t,r.take),this._setDistinct(t,r.distinct),this._setPaginate(t,r.paginate),this._setFields(t,r.fields)}},{key:"_select",value:function(i){var n=this;this.promiseStack.push(new Promise(function(t,r){try{n._odm.promisify(function(e){return e}).then(function(e){e.setMode("shallow").set(i.from),n._selectScope("main",e,i),n._mergeScope("join",e,i.merge),n._joinScope("join",e,i.join);e=n._odm.deepClone(e.exec());i.join&&i.nested&&(e=n._odm.deepClone(n._builderNested(e,i.nested))),t(e)}).catch(function(e){r(e)})}catch(e){r(e)}}))}},{key:"_insert",value:function(i){var e=this;this.promiseStack.push(new Promise(function(t,r){e._odm.promisify(function(e){return e}).then(function(e){t({data:e.set(i.into).insertMany(i.values).exec(),count:i.values.length})}).catch(function(e){r(e)})}))}},{key:"_update",value:function(u){var h=this;this.promiseStack.push(new Promise(function(a,t){h._odm.promisify(function(e){return e}).then(function(e){e.set(u.from),h._builderBetween(e,u.between),h._builderWhere(e,u.where),h._builderSearch(e,u.search),h._builderRegExp(e,u.regexp),h._builderOr(e,u.or);for(var t=h._odm.deepClone(e.exec()),r=Object.keys(u.set),i=t.length,n=r.length,o=0;o<i;o++)for(var s=0;s<n;s++)t[o][r[s]]=u.set[r[s]];a({data:e.set(u.from).updateMany(u.key,t).exec(),count:i})}).catch(function(e){t(e)})}))}},{key:"_modify",value:function(u){var h=this;this.promiseStack.push(new Promise(function(a,t){h._odm.promisify(function(e){return e}).then(function(e){e.set(u.from),h._builderBetween(e,u.between),h._builderWhere(e,u.where),h._builderSearch(e,u.search),h._builderRegExp(e,u.regexp),h._builderOr(e,u.or);for(var t=h._odm.deepClone(e.exec()),r=Object.keys(u.set),i=t.length,n=r.length,o=0;o<i;o++)for(var s=0;s<n;s++)t[o][r[s]]=u.set[r[s]];a({data:e.set(u.from).modifyMany(u.key,t).exec(),count:i})}).catch(function(e){t(e)})}))}},{key:"_delete",value:function(s){var a=this;this.promiseStack.push(new Promise(function(o,t){a._odm.promisify(function(e){return e}).then(function(e){e.set(s.from),a._builderBetween(e,s.between),a._builderWhere(e,s.where),a._builderSearch(e,s.search),a._builderRegExp(e,s.regexp),a._builderOr(e,s.or);for(var t=a._odm.deepClone(e.select([s.key]).exec()),r=[],i=t.length,n=0;n<i;n++)r.push(t[n][s.key]);o({data:e.set(s.from).deleteMany(s.key,r).exec(),count:i})}).catch(function(e){t(e)})}))}},{key:"query",value:function(e){if(this.clean(),this._odm.isArray(e))for(var t in e)for(var r in e[t])if(Object.prototype.hasOwnProperty.call(e[t],r))switch(!0){case"insert"===r:this._insert(e[t].insert);break;case"update"===r:this._update(e[t].update);break;case"modify"===r:this._modify(e[t].modify);break;case"delete"===r:this._delete(e[t].delete);break;default:this._select(e[t].select)}return this}},{key:"exec",value:function(n){var o=this;try{Promise.all(this.promiseStack.map(function(e){return e.then(function(e){return{status:!0,response:e}}).catch(function(e){return{status:!1,error:e}})})).then(function(e){for(var t=e.length,r=0;r<t;++r)o.content.push(e[r]);var i=_toConsumableArray(o.content);n(null,i)})}catch(e){n(e)}}},{key:"promise",value:function(){var e=this;return new Promise(function(r,i){e.exec(function(e,t){return e?i(e):void r(t)})})}}]),e}();t.exports=e},{"fly-json-odm":1}]},{},[4])(4)});